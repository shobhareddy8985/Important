CASE WHEN DECODE(NVL(credit_key, -1), -1, -1, 0)||'|'||
DECODE(NVL(credit_event_type_key, -1), -1, -1, 0)||'|'||
DECODE(NVL(credit_event_reason_key, -1), -1, -1, 0)||'|'||
DECODE(NVL(credit_from_state_key, -1), -1, -1, 0)||'|'||
DECODE(NVL(credit_to_state_key, -1), -1, -1, 0)||'|'||
DECODE(NVL(customer_key, -1), -1, -1, 0)||'|'||
DECODE(NVL(currency_key, -1), -1, -1, 0)||'|'||
DECODE(NVL(order_key, -1), -1, -1, 0)||'|'||
DECODE(NVL(credit_store_key, -1), -1, -1, 0)||'|'||
DECODE(NVL(event_store_key, -1), -1, -1, 0)||'|'||
DECODE(NVL(order_detail_key, -1), -1, -1, 0)||'|'||
DECODE(NVL(order_classification_key, -1), -1, -1, 0)||'|'||
DECODE(NVL(order_channel_key, -1), -1, -1, 0)||'|'||
DECODE(NVL(ship_to_country_key, -1), -1, -1, 0) LIKE '%-1%' THEN 'WARNING-UK:' ELSE '' END

select * from EDM_DB_SYSTEM.ETL_EXCEPTION.fact_credit_event where META_ROW_EXCEPTION_TYPE = 'WARNING-UK:'

select count(*) from EDM_DB_SYSTEM.ETL_EXCEPTION.stg_fact_credit_event where META_ROW_EXCEPTION_TYPE = 'WARNING-UK:'
and meta_job_exec_id= 2572455   ---505582


select count(*) from EDM_DB_SYSTEM.ETL_EXCEPTION.stg_fact_credit_event where META_ROW_EXCEPTION_TYPE = 'WARNING-UK:'
and meta_job_exec_id= 2572455 and ship_to_country_key= -1 ---2643

select count(*) from EDM_DB_SYSTEM.ETL_EXCEPTION.stg_fact_credit_event where META_ROW_EXCEPTION_TYPE = 'WARNING-UK:'
and meta_job_exec_id= 2572455 and credit_event_reason_key = -1 ---498047


select count(*) from EDM_DB_SYSTEM.ETL_EXCEPTION.stg_fact_credit_event where META_ROW_EXCEPTION_TYPE = 'WARNING-UK:'
and meta_job_exec_id= 2572455 and credit_from_state_key = -1 ---4895


df_edw_stg_fact_credit_event

credit_event_reason_key

NVL(SRC_dim_credit_event_reason_credit_event_reason_key.CREDIT_EVENT_REASON_KEY, -1)


select CREDIT_EVENT_REASON_KEY,* from EDM_DB_SYSTEM.ETL_staging.stg_fact_credit_event where  STORE_CREDIT_ID=71704327


WITH SRC_t_STG_FACT_CREDIT_EVENT AS
(
SELECT
SRC_t_STG_FACT_CREDIT_EVENT.STORE_CREDIT_ID AS STORE_CREDIT_ID
,SRC_t_STG_FACT_CREDIT_EVENT.EVENT_HQ_DATE AS EVENT_HQ_DATE
,SRC_t_STG_FACT_CREDIT_EVENT.EVENT_LOCAL_DATE AS EVENT_LOCAL_DATE
,SRC_t_STG_FACT_CREDIT_EVENT.CREDIT_EVENT_TYPE_NAME AS CREDIT_EVENT_TYPE_NAME
,SRC_t_STG_FACT_CREDIT_EVENT.CREDIT_EVENT_REASON AS CREDIT_EVENT_REASON
,SRC_t_STG_FACT_CREDIT_EVENT.CREDIT_FROM_STATE AS CREDIT_FROM_STATE
,SRC_t_STG_FACT_CREDIT_EVENT.CREDIT_TO_STATE AS CREDIT_TO_STATE
,SRC_t_STG_FACT_CREDIT_EVENT.CUSTOMER_ID AS CUSTOMER_ID
,SRC_t_STG_FACT_CREDIT_EVENT.ISO_CURRENCY_CODE AS ISO_CURRENCY_CODE
,SRC_t_STG_FACT_CREDIT_EVENT.CURRENCY_EXCHANGE_RATE_TYPE AS CURRENCY_EXCHANGE_RATE_TYPE
,SRC_t_STG_FACT_CREDIT_EVENT.EVENT_STORE_KEY AS EVENT_STORE_KEY
,SRC_t_STG_FACT_CREDIT_EVENT.ORDER_ID AS ORDER_ID
,SRC_t_STG_FACT_CREDIT_EVENT.ORDER_KEY AS ORDER_KEY
,SRC_t_STG_FACT_CREDIT_EVENT.ORDER_DETAIL_KEY AS ORDER_DETAIL_KEY
,SRC_t_STG_FACT_CREDIT_EVENT.ORDER_CLASSIFICATION_KEY AS ORDER_CLASSIFICATION_KEY
,SRC_t_STG_FACT_CREDIT_EVENT.ORDER_CHANNEL_KEY AS ORDER_CHANNEL_KEY
,SRC_t_STG_FACT_CREDIT_EVENT.SHIP_TO_COUNTRY_KEY AS SHIP_TO_COUNTRY_KEY
,SRC_t_STG_FACT_CREDIT_EVENT.EVENT_HQ_DATETIME AS EVENT_HQ_DATETIME
,SRC_t_STG_FACT_CREDIT_EVENT.EVENT_LOCAL_DATETIME AS EVENT_LOCAL_DATETIME
,SRC_t_STG_FACT_CREDIT_EVENT.EVENT_DATE_USD_CONV_RATE AS EVENT_DATE_USD_CONV_RATE
,SRC_t_STG_FACT_CREDIT_EVENT.EVENT_DATE_EUR_CONV_RATE AS EVENT_DATE_EUR_CONV_RATE
,SRC_t_STG_FACT_CREDIT_EVENT.EVENT_COUNT AS EVENT_COUNT
,SRC_t_STG_FACT_CREDIT_EVENT.EFFECTIVE_VAT_RATE AS EFFECTIVE_VAT_RATE
,SRC_t_STG_FACT_CREDIT_EVENT.CREDIT_ORIGINAL_AMOUNT AS CREDIT_ORIGINAL_AMOUNT
,SRC_t_STG_FACT_CREDIT_EVENT.BALANCE_CHANGE_GROSS_OF_VAT_LOCAL_AMOUNT AS BALANCE_CHANGE_GROSS_OF_VAT_LOCAL_AMOUNT
,SRC_t_STG_FACT_CREDIT_EVENT.REMAINING_BALANCE_GROSS_OF_VAT_LOCAL_AMOUNT AS REMAINING_BALANCE_GROSS_OF_VAT_LOCAL_AMOUNT
,SRC_t_STG_FACT_CREDIT_EVENT.FULFILLED_BALANCE_CHANGE_GROSS_OF_VAT_LOCAL_AMOUNT AS FULFILLED_BALANCE_CHANGE_GROSS_OF_VAT_LOCAL_AMOUNT
,SRC_t_STG_FACT_CREDIT_EVENT.FULFILLED_BALANCE_GROSS_OF_VAT_LOCAL_AMOUNT AS FULFILLED_BALANCE_GROSS_OF_VAT_LOCAL_AMOUNT
,SRC_t_STG_FACT_CREDIT_EVENT.BALANCE_CHANGE_VAT_LOCAL_AMOUNT AS BALANCE_CHANGE_VAT_LOCAL_AMOUNT
,SRC_t_STG_FACT_CREDIT_EVENT.REMAINING_BALANCE_VAT_LOCAL_AMOUNT AS REMAINING_BALANCE_VAT_LOCAL_AMOUNT
,SRC_t_STG_FACT_CREDIT_EVENT.FULFILLED_BALANCE_CHANGE_VAT_LOCAL_AMOUNT AS FULFILLED_BALANCE_CHANGE_VAT_LOCAL_AMOUNT
,SRC_t_STG_FACT_CREDIT_EVENT.FULFILLED_BALANCE_VAT_LOCAL_AMOUNT AS FULFILLED_BALANCE_VAT_LOCAL_AMOUNT
,SRC_t_STG_FACT_CREDIT_EVENT.BALANCE_CHANGE_LOCAL_AMOUNT AS BALANCE_CHANGE_LOCAL_AMOUNT
,SRC_t_STG_FACT_CREDIT_EVENT.REMAINING_BALANCE_LOCAL_AMOUNT AS REMAINING_BALANCE_LOCAL_AMOUNT
,SRC_t_STG_FACT_CREDIT_EVENT.FULFILLED_BALANCE_CHANGE_LOCAL_AMOUNT AS FULFILLED_BALANCE_CHANGE_LOCAL_AMOUNT
,SRC_t_STG_FACT_CREDIT_EVENT.FULFILLED_BALANCE_LOCAL_AMOUNT AS FULFILLED_BALANCE_LOCAL_AMOUNT
,SRC_t_STG_FACT_CREDIT_EVENT.META_OPERATION_IND AS META_OPERATION_IND
,SRC_t_STG_FACT_CREDIT_EVENT.META_FIXED_METRIC_HASH_LKP AS META_FIXED_METRIC_HASH_LKP
,SRC_t_STG_FACT_CREDIT_EVENT.CREDIT_STORE_KEY AS CREDIT_STORE_KEY
,SRC_t_STG_FACT_CREDIT_EVENT.CREDIT_EVENT_KEY AS CREDIT_EVENT_KEY
,to_timestamp_ntz('2019-10-18 03:48:46.194') AS meta_create_datetime
FROM
edm_db_system.etl_staging.t_STG_FACT_CREDIT_EVENT_2836 SRC_t_STG_FACT_CREDIT_EVENT
)
SELECT
SRC_t_STG_FACT_CREDIT_EVENT.STORE_CREDIT_ID AS STORE_CREDIT_ID
,SRC_t_STG_FACT_CREDIT_EVENT.CREDIT_EVENT_REASON 
,SRC_dim_credit_event_reason_credit_event_reason_key.CREDIT_EVENT_REASON as dim_credit_reason_key
,NVL(SRC_dim_credit_event_reason_credit_event_reason_key.CREDIT_EVENT_REASON_KEY, -1) AS credit_event_reason_key
FROM
SRC_t_STG_FACT_CREDIT_EVENT

LEFT OUTER JOIN
edm_db_edw.mart.DIM_CREDIT SRC_dim_credit_credit_key
ON
(SRC_t_STG_FACT_CREDIT_EVENT.STORE_CREDIT_ID = SRC_dim_credit_credit_key.STORE_CREDIT_ID AND NVL(SRC_t_STG_FACT_CREDIT_EVENT.EVENT_HQ_DATETIME,SRC_t_STG_FACT_CREDIT_EVENT.meta_create_datetime) BETWEEN SRC_dim_credit_credit_key.META_EFFECTIVE_START_DATETIME AND SRC_dim_credit_credit_key.META_EFFECTIVE_END_DATETIME)

LEFT OUTER JOIN
edm_db_edw.mart.DIM_DATE SRC_dim_date_event_hq_date_key
ON
(SRC_t_STG_FACT_CREDIT_EVENT.EVENT_HQ_DATE = SRC_dim_date_event_hq_date_key.FULL_DATE)

LEFT OUTER JOIN
edm_db_edw.mart.DIM_DATE SRC_dim_date_event_local_date_key
ON
(SRC_t_STG_FACT_CREDIT_EVENT.EVENT_LOCAL_DATE = SRC_dim_date_event_local_date_key.FULL_DATE)

LEFT OUTER JOIN
edm_db_edw.mart.DIM_CREDIT_EVENT_TYPE SRC_dim_credit_event_type_credit_event_type_key
ON
(SRC_t_STG_FACT_CREDIT_EVENT.CREDIT_EVENT_TYPE_NAME = SRC_dim_credit_event_type_credit_event_type_key.CREDIT_EVENT_TYPE_NAME
AND NVL(SRC_t_STG_FACT_CREDIT_EVENT.EVENT_HQ_DATETIME,SRC_t_STG_FACT_CREDIT_EVENT.meta_create_datetime) BETWEEN SRC_dim_credit_event_type_credit_event_type_key.META_EFFECTIVE_START_DATETIME AND SRC_dim_credit_event_type_credit_event_type_key.META_EFFECTIVE_END_DATETIME)

LEFT OUTER JOIN
edm_db_edw.mart.DIM_CREDIT_EVENT_REASON SRC_dim_credit_event_reason_credit_event_reason_key
ON
(SRC_t_STG_FACT_CREDIT_EVENT.CREDIT_EVENT_REASON = SRC_dim_credit_event_reason_credit_event_reason_key.CREDIT_EVENT_REASON
AND NVL(SRC_t_STG_FACT_CREDIT_EVENT.EVENT_HQ_DATETIME,SRC_t_STG_FACT_CREDIT_EVENT.meta_create_datetime) BETWEEN SRC_dim_credit_event_reason_credit_event_reason_key.META_EFFECTIVE_START_DATETIME
AND SRC_dim_credit_event_reason_credit_event_reason_key.META_EFFECTIVE_END_DATETIME)

where SRC_t_STG_FACT_CREDIT_EVENT.STORE_CREDIT_ID =71704327
